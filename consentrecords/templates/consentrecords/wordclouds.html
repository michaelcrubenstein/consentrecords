<!DOCTYPE html>
<html lang="en"
	xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="https://www.facebook.com/2008/fbml">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-title" content="PathAdvisor">

	{% if fbURL %}
    <meta property="og:url" content="{{fbURL}}">
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{fbTitle}}">
    <meta property="og:description" content="{{fbDescription}}">
    {% endif %}

    <title>PathAdvisor</title>

	<link href="{% static "jqcloud2/dist/jqcloud.min.css" %}?v={{jsversion}}" rel="stylesheet">
	
    <!-- Custom styles for this page -->
    <link href="{% static "custom_user/css/base.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "switchery/css/switchery.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/base.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/comparePathsPanel.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/experienceCommentsPanel.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/tagPoolView.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/findExperience.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/newExperiencePanel.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/pathtreePanel.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/searchpaths.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/showFollowing.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/showSharing.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/signup.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/welcomePanel.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "consentrecords/css/wordclouds.css" %}?v={{jsversion}}" rel="stylesheet">
    
    <link href="{% static "custom_user/css/formsimple.css" %}?v={{jsversion}}" rel="stylesheet">
    <link href="{% static "custom_user/css/signin.css" %}?v={{jsversion}}" rel="stylesheet">

    <style>
    </style>
	</head>
	
  	<body class="site-body">
		{% if facebookIntegration %}
  		<div id="fb-root"></div>
		<script>
		  window.fbAsyncInit = function() {
			FB.init({
			  appId      : '1503871976607590',
			  status     : true,
			  cookie     : true,
			  xfbml      : true,
			  version    : 'v2.5'
			});
		  };

		  (function(d, s, id){
			 var js, fjs = d.getElementsByTagName(s)[0];
			 if (d.getElementById(id)) {return;}
			 js = d.createElement(s); js.id = id;
			 js.src = "//connect.facebook.net/en_US/sdk.js";
			 fjs.parentNode.insertBefore(js, fjs);
		   }(document, 'script', 'facebook-jssdk'));
		</script>
		{% endif %}
		
  		<panel class='wordcloud' id='wordcloud_panel' >
  			<panel class='panel-fill'>
  				<section class='wordcloud' >
  				</section>
  			</panel>
		</panel>
		
<!--     IE10 viewport hack for Surface/desktop Windows 8 bug -->
    	<script src="{% static "bootstrap/assets/js/ie10-viewport-bug-workaround.js" %}?v={{jsversion}}"></script>
  	</body>

	<script src="{{cdn_url}}jquery/3.1.1/jquery.min.js"></script>
	<script src="{{cdn_url}}spin.js/2.3.2/spin.min.js"></script>
	<script src="{{cdn_url}}hammer.js/2.0.8/hammer.min.js"></script>
	<script src="{{cdn_url}}jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="{{cdn_url}}twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="{{cdn_url}}jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
	<script src="{{cdn_url}}d3/3.5.17/d3.min.js"></script>
	<script src="{{cdn_url}}datejs/1.0/date.min.js"></script>
	<script src="{{cdn_url}}clipboard.js/1.7.1/clipboard.min.js"></script>
	<script src="{% static "custom_user/js/bootstrapalert.js" %}"></script>
	<script src="{% static "datejs/time.js" %}?v={{jsversion}}"></script>
	<script src="{% static "switchery/js/switchery.js" %}?v={{jsversion}}"></script>
	<script src="{% static "uuid/uuid.3.0.0.js" %}?v={{jsversion}}"></script>
	<script src="{% static "jqcloud2/dist/jqcloud.min.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/models.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/domainmodels.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/controllers.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/views.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/tagPoolView.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/getDataChunker.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/dateinput.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/dotsnavigator.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/experienceCommentsPanel.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/findExperience.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/hilitePanel.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/newExperiencePanel.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/organization.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/orgviews.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/pathGuides.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/pathtreePanel.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/quickAddExperiencePanel.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/searchPaths.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/comparePathsPanel.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/showFollowing.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/showSharing.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/signup.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/settings.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/updatePassword.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/welcomeOrganization.js" %}?v={{jsversion}}"></script>
	<script src="{% static "consentrecords/js/welcomePanel.js" %}?v={{jsversion}}"></script>
	
	<!-- Scripts for this web page -->
	<script type="text/JavaScript">
		staticPath = '{% static "" %}';
		jsVersionPathSuffix = '?v={{jsversion}}';
		rightChevronPath = '{% static "consentrecords/png/ios7-arrow-forward-512px.svg" %}' + jsVersionPathSuffix;
		addImagePath = '{% static "consentrecords/png/add.png" %}' + jsVersionPathSuffix;
		settingsImagePath = '{% static "consentrecords/png/settings.png" %}' + jsVersionPathSuffix;
		notificationsImagePath = '{% static "consentrecords/png/notifications.png" %}' + jsVersionPathSuffix;
		shareImagePath = '{% static "consentrecords/png/share.svg" %}' + jsVersionPathSuffix;
		myPathwayImagePath = '{% static "consentrecords/png/mypathway.svg" %}' + jsVersionPathSuffix;
		compareImagePath = '{% static "consentrecords/png/compare.svg" %}' + jsVersionPathSuffix;
		inquiryImagePath = '{% static "consentrecords/png/signup.svg" %}' + jsVersionPathSuffix;
		logoPath = '{% static "consentrecords/png/LOGO 1.png" %}' + jsVersionPathSuffix;
		deleteButtonPath = '{% static "consentrecords/png/delete.png" %}' + jsVersionPathSuffix;
		
		function csrfSafeMethod(method) {
			// these HTTP methods do not require CSRF protection
			return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}
		$.ajaxSetup({
			beforeSend: function(xhr, settings) {
				if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
					xhr.setRequestHeader("X-CSRFToken", $.cookie("csrftoken"));
				}
			}
		});

		window.onbeforeunload = function(event) {
			event = event || window.event;
			
			if (event)
				event.returnValue = "Leaving this page will leave the PathAdvisor web application.";
			
			// For Safari
			return "Leaving this page will leave the PathAdvisor web application.";
		};

		function checkSignin(handleState)
		{
			if (prepareClick('checkSignin'))
			{
				var onSignin = function(eventObject)
				{
					this.off("signinCanceled.cr", onSigninCanceled);
					var firstPanel = new HomePanel(cr.signedinUser, false);
					firstPanel.pathtree.setUser(cr.signedinUser.path(), true)
						.then(function()
							{
								handleState(firstPanel)
							});
					firstPanel.showUp();
				};
			
				var onSigninCanceled = function(eventObject)
				{
					this.off("signin.cr", onSignin);
					var firstPanel = new WelcomePanel();
					firstPanel.showLeft();
				}
			
				cr.signedinUser.one("signin.cr", null, onSignin);
				cr.signedinUser.one("signinCanceled.cr", null, onSigninCanceled);
			
				var panel = new SigninPanel();
				panel.showLeft().then(function()
							{
								panel.initializeFocus();
								unblockClick();
							});
			}
		}
		
		function showWords(words, update)
		{
			words.forEach(function(w)
				{
					var service = crp.getInstance(w.id);
					w.text = service.description();
					w.color = service.getColor();
					w.handlers = {click: filterPaths};
					w.html={serviceID: w.id}
				});
			if (update)
				{
					$('section.wordcloud').jQCloud('update', words);
				}
			else
			{
				$('section.wordcloud').jQCloud(words,
					{autoResize: true,
					 removeOverflowing: false});
			}
		}
		
		function updateWords(words)
		{
			return showWords(words, true);
		}
		
		function filterPaths()
		{
			return cr.getFollowingCounts('path', 'service/{0}'.format(this.getAttribute('serviceID')))
				.then(updateWords, cr.asyncFail);
		}
		
		$(document).ready (function(e) {						
			var firstPanel;
			
			cr.Service.servicesPromise()
				.then(function(services)
					{
						return cr.getServiceCounts('path')
							.then(showWords, cr.asyncFail);
					},
					cr.asyncFail);
			
			return;
			
			/* handleState is an asynchronous function called when the setup is ready to process it. */
			/* needsSignin is a flag that determines if handling the state requires signin. */
			var handleState = null;
			var needsSignin = false;

			{% if userID %}
			if (!navigator.cookieEnabled)
			{
				firstPanel = new WelcomePanel();
				firstPanel.showNow();
				cr.asyncFail(new Error(crv.buttonTexts.cookiesRequired));
			}
			else
			{
				cr.createSignedinUser("{{userID}}")
					.fail(function(err)
						{
							cr.signedinUser.clear();
							firstPanel = new WelcomePanel();
							firstPanel.showNow();
							cr.asyncFail(err);
						});
					
				cr.signedinUser.one("signin.cr", null, function(eventObject)
					{
						try
						{
							console.assert(cr.signedinUser.path());
							firstPanel = new HomePanel(cr.signedinUser, false);
							firstPanel.showNow();
							firstPanel.pathtree.setUser(cr.signedinUser.path(), true)
							.then(function()
								{
									if (handleState)
										handleState(firstPanel);
								})
							.fail(cr.asyncFail);	/* Catch errors in any previous promise in the chain. */
						}
						catch(err)
						{
							cr.asyncFail(err);
						}
					});
			}
			{% endif %}
			
			/* Initialize all of the objects that are dependent on whether or not the user is
				signed in.
			 */
			if (!cr.signedinUser.id())
			{
				if (needsSignin)
				{
					if (!navigator.cookieEnabled)
					{
						firstPanel = new WelcomePanel();
						firstPanel.showNow();
						cr.asyncFail(new Error(crv.buttonTexts.cookiesRequired));
					}
					else
					{
						firstPanel = null;
						checkSignin(handleState);
					}
				}
				else if (handleState)
					handleState();
				else
				{
					firstPanel = new WelcomePanel();
					firstPanel.showNow();
				}
			}
		});
		
		function sign_out() {
			bootstrap_alert.show($('#myAlert'), "Signing Out...", "alert-info");
			return cr.submitSignout()
				.then(function()
					{
						ServiceFlagController.clearPromises();
						var sitePanels = $("panel.site-panel");
						var panel = new WelcomePanel();
						panel.showNow();
						sitePanels.trigger("hiding.cr");
						return $(sitePanels[sitePanels.length - 1]).hide("slide", {direction: "down"}, 400,
							function() {
								sitePanels.remove();
								bootstrap_alert.close();
							}).promise();
					});
		}
		
		function setMetaProperties(session, targetHRef)
		{
			var headDiv = d3.select("head");
			headDiv.selectAll("meta").each(function()
			{
				var metaObj = d3.select(this);
				if (metaObj.attr("property") &&
					metaObj.attr("property").startsWith("og:"))
					metaObj.remove();
			});
			var offering = session.offering();
			var organization = session.organization();
			var a = [{property: "og:url", content: targetHRef},
					 {property: "og:type", content: "website" },
					 {property: "og:title", content: offering.description()},
					 {property: "og:description", content: session.description() + "\n" + organization.description()}];
			for (var i = 0; i < a.length; i++)
			{
				if (a[i].content)
					headDiv.append("meta")
						.attr("property", a[i].property)
						.attr("content", a[i].content);
			}
		}
		
		function appendFacebookButton(shareDiv, service, session)
		{
			var targetHRef = window.location.origin+"/find/"+service.id()+"/"+session.id();

			setMetaProperties(session, targetHRef);
			var fbDiv = shareDiv.div.append("div")
				.classed('fb-share-button', true)
				.attr("data-href", targetHRef)
				.attr("data-layout", "button_count");
			var fbImage = fbDiv.append("img")
				.attr("src", "{% static "consentrecords/png/fb.png" %}")
				.style("height", "22px")
				.style("weight", "22px");
			{% if facebookIntegration %}
			fbDiv.on("click", function() {
				FB.ui({
					  method     : 'share',
					  href       : targetHRef
					  }, function(response){});
				d3.event.preventDefault();
			});
			{% endif %}
		}
		
		function validateEmail(email) 
		{
			var re = /\S+@\S+\.\S\S+/;
			return re.test(email);
		}
		
	</script>
		
</html>

